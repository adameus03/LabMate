<!DOCTYPE html>
<html>

<!-- ACKNOWLEDGEMENT: Table styling based on https://github.com/QualityDU/QualityDU/blob/master/backend/templates/act/acts-table.html -->

<head>
  <title>LabMate Reagents</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>

  <style>
    .toast-container {
      z-index: 1055;
    }

    .toast {
      opacity: 0.9;
      margin-bottom: 10px;
    }
  </style>

  <div class="container my-4">
    <h2 class="text-center mb-4">Reagents Listing</h2>

    <!-- Add New Reagent Button -->
    <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addReagentModal">Add new
      reagent</button>

    <div class="input-group mb-3">

      <!-- "Filter by" Text -->
      <span class="input-group-text">Filter by</span>

      <!-- Select Dropdown -->
      <select class="form-select form-select-lg flex-grow-1" aria-label="Filter type options">
        <option selected>no filter</option>
        <option value="1">name</option>
        <option value="2">vendor</option>
        <option value="3">type</option>
      </select>

      <!-- Input Field -->
      <!--<input type="text" class="form-control flex-grow-1" placeholder="Filter value" aria-label="Filter value">-->
      <select class="form-select select2" aria-label="Filter value" required>
        <option value="1">organosilicon compounds</option>
        <option value="2">organic salts</option>
        <option value="3">acids</option>
      </select>

      <!-- Filter Button -->
      <button class="btn btn-outline-secondary" type="button" id="button-addon2">APPLY</button>
    </div>

    <!-- Toggle Button -->
    <div class="input-group-text mb-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleInputType">
        <label class="form-check-label" for="toggleInputType">Enable dropdown for filter value</label>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-primary">
          <tr>
            <th>Name</th>
          </tr>
        </thead>
        <tbody id="reagent-names-tbody">
          <!-- <tr>
            <td>BSA</td>
          </tr>
          <tr>
            <td>BSTFA</td>
          </tr> -->
        </tbody>
      </table>
    </div>

    <!-- Modal for Adding New Reagent -->
    <div class="modal fade" id="addReagentModal" tabindex="-1" aria-labelledby="addReagentModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h5 class="modal-title" id="addReagentModalLabel">Add New Reagent</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">
            <form id="reagentForm">
              <!-- Name Input -->
              <div class="mb-3">
                <label for="reagentName" class="form-label">Name</label>
                <input type="text" class="form-control" id="reagentName" placeholder="Enter reagent name" required>
              </div>

              <!-- Vendor Dropdown (Searchable) -->
              <div class="mb-3">
                <label for="reagentVendor" class="form-label">Vendor</label>
                <select class="form-select select2" id="reagentVendor" required>
                  <option value="">Select a vendor</option>
                  <!-- <option value="1">Sigma Aldrich</option>
                  <option value="2">Merck</option>
                  <option value="3">ABC Chem</option> -->
                </select>
              </div>

              <!-- Type Dropdown (Searchable) -->
              <div class="mb-3">
                <label for="reagentType" class="form-label">Type</label>
                <select class="form-select select2" id="reagentType" required>
                  <option value="">Select a type</option>
                  <!-- <option value="1">organosilicon compounds</option>
                  <option value="2">organic salts</option>
                  <option value="3">acids</option> -->
                </select>
              </div>
            </form>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" form="reagentForm">Save</button>
          </div>
        </div>
      </div>
    </div>

    <nav aria-label="Paginacja">
      <ul class="pagination justify-content-center">

        <li class="page-item disabled"><span class="page-link">«</span></li>

        <li class="page-item active"><span class="page-link">1</span></li>

        <li class="page-item"><a class="page-link" href="/act/all?page=2">2</a></li>

        <li class="page-item"><a class="page-link" href="/act/all?page=3">3</a></li>

        <li class="page-item disabled"><span class="page-link">…</span></li>

        <li class="page-item"><a class="page-link" href="/act/all?page=4337">4337</a></li>

        <li class="page-item"><a class="page-link" href="/act/all?page=4338">4338</a></li>

        <li class="page-item">
          <a class="page-link" href="/act/all?page=2" aria-label="Następna">
            »
          </a>
        </li>

      </ul>
    </nav>
  </div>

  <script>
    const LABSERV_API_URL = "http://127.0.0.1:7890/api";

    let globals = {
      "elements": null
    };

    function assert(condition, message) {
      if (!condition) {
          alert(message || "Assertion failed!"); // Show a message to the user
          throw new Error(message || "Assertion failed!"); // Stop execution
      }
    }

    function __parentCheck() {
      if (window.self == window.parent) {
        alert('You tinkered with the website, so now it won\'t work. Bye bye');
        window.location.href = 'logged-common.html?c=chat';
        return;
      }
    }
    function getElements() {
      return {
        reagentForm: document.getElementById("reagentForm"),
        reagentNamesTbody: document.getElementById("reagent-names-tbody"),
        reagentVendorSelect: document.getElementById("reagentVendor"),
        reagentTypeSelect: document.getElementById("reagentType")
      };
    }

    async function fetchXsCount(xsName) {
      assert(typeof xsName === "string", "xsName is not a string");
      try {
        const response = await fetch(`${LABSERV_API_URL}/${xsName}`);
        assert(response.ok, `Failed to fetch ${xsName} count! Falsy response.ok, response.status=${response.status}`);
        const data = await response.json();
        
        assert(data, `data is falsy`);
        console.log(`GET ${LABSERV_API_URL}/${xsName}`, data);
        assert(data.status, `status is falsy`);
        if (data.status !== "success") {
          assert(false, `Failed to fetch ${xsName} count! Message from LABSERV: ${data.message}`);
          return -1;
        } else {
          assert(data[`${xsName}_count`] || data[`${xsName}_count`] === 0, `${xsName}_count is falsy and not 0`);
          assert(data[`${xsName}_count`] >= 0, `${xsName}_count is negative`);
          if (data[`${xsName}_count`] === 0) {
            console.log(`No ${xsName} found`);
            alert(`No ${xsName} found yet... Add some?`);
          }
          return data[`${xsName}_count`];
        }
      } catch (error) {
        assert(false, `Failed to fetch ${xsName} count! Error: ${error}`);
        return -1;
      };
    }

    function __fetchXs_ParametrizationObject_SanCheck(xParametrizationObject) {
      assert(typeof xParametrizationObject === "object", "xParametrizationObject is not an object");
      assert(typeof xParametrizationObject.xsName === "string", "xParametrizationObject.xsName is not a string");
      assert(Array.isArray(xParametrizationObject.xFilterOptions), "xParametrizationObject.xFilterOptions is not an array");
      for (let i = 0; i < xParametrizationObject.xFilterOptions.length; i++) {
        assert(typeof xParametrizationObject.xFilterOptions[i] === "string", "xParametrizationObject.xFilterOptions[i] is not a string");
      }
    }

    function __fetchXs_ParametrizationObject(xsName, xFilterOptions) {
      assert(typeof xsName === "string", "xsName is not a string");
      assert(Array.isArray(xFilterOptions), "xFilterOptions is not an array");
      for (let i = 0; i < xFilterOptions.length; i++) {
        assert(typeof xFilterOptions[i] === "string", "xFilterOptions[i] is not a string");
      }
      return {
        "xsName": xsName,
        "xFilterOptions": xFilterOptions
      };
    }

    async function fetchXs(xParametrizationObject, filterParam, filterValue, p_offset, p_size) {
      __fetchXs_ParametrizationObject_SanCheck(xParametrizationObject);
      assert(xParametrizationObject.xFilterOptions.includes(filterParam), "Invalid filterParam");
      assert(typeof filterValue === "string", "filterValue is not a string");
      assert(typeof p_offset === "number", "p_offset is not a number");
      assert(typeof p_size === "number", "p_size is not a number");
      assert(p_offset >= 0, "p_offset is negative");
      assert(p_size > 0, "p_size is not positive");
      assert(Number.isInteger(p_offset), "p_offset is not an integer");
      assert(Number.isInteger(p_size), "p_size is not an integer");

      try {
        const response = await fetch(`${LABSERV_API_URL}/${xParametrizationObject.xsName}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            filter: `${filterParam}`,
            value: `${filterValue}`,
            p_offset: p_offset,
            p_size: p_size
          })
        });
        assert(response.ok, `Failed to fetch ${xParametrizationObject.xsName}! Falsy response.ok, response.status=${response.status}`);
        const data = await response.json();
        
        assert(data, `data is falsy`);
        console.log(`POST ${LABSERV_API_URL}/${xParametrizationObject.xsName}`, data);
        assert(data.status, `status is falsy`);
        if (data.status !== "success") {
          assert(false, `Failed to fetch ${xParametrizationObject.xsName}! Message from LABSERV: ${data.message}`);
          return [];
        } else {
          assert(data[xParametrizationObject.xsName], `${xParametrizationObject.xsName} is falsy`);
          assert(Array.isArray(data[xParametrizationObject.xsName]), `${xParametrizationObject.xsName} is not an array`);
          return data[xParametrizationObject.xsName];
        }
      } catch (error) {
        assert(false, `Failed to fetch ${xParametrizationObject.xsName}! Error: ${error}`);
        return [];
      }
    }

    // TODO Use `fetchXsCount`
    async function fetchReagentsCount() {
      // GET `${LABSERV_API_URL}/reagents` -> { status: "success|error", message: "...", ("reagents_count": <n>)}
      try {
        const response = await fetch(`${LABSERV_API_URL}/reagents`);
        assert(response.ok, "Failed to fetch reagents count! Falsy response.ok, response.status=" + response.status);
        const data = await response.json();
        
        assert(data, "data is falsy");
        console.log(`GET ${LABSERV_API_URL}/reagents`, data);
        assert(data.status, "status is falsy");
        if (data.status !== "success") {
          assert(false, `Failed to fetch reagents count! Message from LABSERV: ${data.message}`);
          return -1;
        } else {
          assert(data.reagents_count || data.reagents_count === 0, "reagents_count is falsy and not 0");
          assert(data.reagents_count >= 0, "reagents_count is negative");
          if (data.reagents_count === 0) {
            console.log("No reagents found");
            alert("No reagents found, you can add some using the \"Add new reagent\" button");
          }
          return data.reagents_count;
        } 
      } catch (error) {
        assert(false, "Failed to fetch reagents count! Error: " + error);
        return -1;
      };
    }

    // TODO Use `fetchXs`
    async function fetchReagents(filterParam, filterValue, p_offset, p_size) {
      // POST -d '{"filter": "<none|name|vendor|reagtype_id>", "value": "<value>", "p_offset": <p_offset>, "p_size": <p_size>}' `${LABSERV_API_URL}/reagents` -> { status: "success|error", message: "...", ("reagents": [{ "reagent_id": <id>, "name": "<name>", "vendor": "<vendor>", "reagtype_id": <reagtype_id>}, ...])}
      assert(["none", "name", "vendor", "reagtype_id"].includes(filterParam), "Invalid filterParam");
      assert(typeof filterValue === "string", "filterValue is not a string");
      assert(typeof p_offset === "number", "p_offset is not a number");
      assert(typeof p_size === "number", "p_size is not a number");
      assert(p_offset >= 0, "p_offset is negative");
      assert(p_size > 0, "p_size is not positive");
      assert(Number.isInteger(p_offset), "p_offset is not an integer");
      assert(Number.isInteger(p_size), "p_size is not an integer");
      
      try {
        const response = await fetch(`${LABSERV_API_URL}/reagents`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            filter: `${filterParam}`,
            value: `${filterValue}`,
            p_offset: p_offset,
            p_size: p_size
          })
        });
        assert(response.ok, "Failed to fetch reagents! Falsy response.ok, response.status=" + response.status);
        const data = await response.json();
        
        assert(data, "data is falsy");
        console.log(`POST ${LABSERV_API_URL}/reagents`, data);
        assert(data.status, "status is falsy");
        if (data.status !== "success") {
          assert(false, `Failed to fetch reagents! Message from LABSERV: ${data.message}`);
          return [];
        } else {
          assert(data.reagents, "reagents is falsy");
          assert(Array.isArray(data.reagents), "reagents is not an array");
          return data.reagents;
        }
      } catch (error) {
        assert(false, "Failed to fetch reagents! Error: " + error);
        return [];
      }
    }

    async function fetchVendorsCount() {
      // GET `${LABSERV_API_URL}/vendors` -> { status: "success|error", message: "...", ("vendors_count": <n>)}
      return fetchXsCount("vendors");
    }

    async function fetchVendors(filterParam, filterValue, p_offset, p_size) {
      // POST -d '{"filter": "<none|name>", "value": "<value>", "p_offset": <p_offset>, "p_size": <p_size>}' `${LABSERV_API_URL}/reagents` -> { status: "success|error", message: "...", ("vendors": [{ "vendor_id": <id>, "name": "<name>"}, ...])}
      const xParametrizationObject = __fetchXs_ParametrizationObject("vendors", ["none", "name"]);
      return fetchXs(xParametrizationObject, filterParam, filterValue, p_offset, p_size);
    }

    async function fetchReagentTypesCount() {
      // GET `${LABSERV_API_URL}/reagtypes` -> { status: "success|error", message: "...", ("reagtypes_count": <n>)}
      return fetchXsCount("reagtypes");
    }

    async function fetchReagentTypes(filterParam, filterValue, p_offset, p_size) {
      // POST -d '{"filter": "<none|name>", "value": "<value>", "p_offset": <p_offset>, "p_size": <p_size>}' `${LABSERV_API_URL}/reagtypes` -> { status: "success|error", message: "...", ("reagtypes": [{ "reagtype_id": <id>, "name": "<name>"}, ...])}
      const xParametrizationObject = __fetchXs_ParametrizationObject("reagtypes", ["none", "name"]);
      return fetchXs(xParametrizationObject, filterParam, filterValue, p_offset, p_size);
    }

    async function loadContent(elements) {
      let reagentsCount = await fetchReagentsCount();
      console.log("reagentsCount: ", reagentsCount);
      let reagents = await fetchReagents("none", "", 0, reagentsCount);
      for (let i = 0; i < reagents.length; i++) {
        let tr = document.createElement("tr");
        let td = document.createElement("td");
        td.textContent = reagents[i].name;
        tr.appendChild(td);
        elements.reagentNamesTbody.appendChild(tr);
      }

      let vendorsCount = await fetchVendorsCount();
      console.log("vendorsCount: ", vendorsCount);
      let vendors = await fetchVendors("none", "", 0, vendorsCount);
      for (let i = 0; i < vendors.length; i++) {
        let option = document.createElement("option");
        option.value = vendors[i].vendor_id;
        option.textContent = vendors[i].name;
        elements.reagentVendorSelect.appendChild(option);
      }

      let reagentTypesCount = await fetchReagentTypesCount();
      console.log("reagentTypesCount: ", reagentTypesCount);
      let reagentTypes = await fetchReagentTypes("none", "", 0, reagentTypesCount);
      for (let i = 0; i < reagentTypes.length; i++) {
        let option = document.createElement("option");
        option.value = reagentTypes[i].reagtype_id;
        option.textContent = reagentTypes[i].name;
        elements.reagentTypeSelect.appendChild(option);
      }
    }
    function __setActions_reagentFormSubmission(elements) {
      elements.reagentForm
      .addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent the form from submitting the traditional way

        // Get input values
        const name = document.getElementById("reagentName").value;
        const vendor = document.getElementById("reagentVendor").value;
        const type = document.getElementById("reagentType").value;

        // Log the data (you can replace this with an API call or other logic)
        console.log("New Reagent Data:", { name, vendor, type });

        // Close the modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("addReagentModal")
        );
        modal.hide();

        // Clear the form (optional)
        document.getElementById("reagentForm").reset();

        // Show a success message (optional)
        alert("Reagent added successfully!");
      });
    }

    function setActions(elements) {
      __setActions_reagentFormSubmission(elements);
    }

    window.onload = async function () {
      __parentCheck();
      globals.elements = getElements();
      await loadContent(globals.elements);
      setActions(globals.elements);
      console.log(globals);
    }
  </script>
</body>

</html>