<!DOCTYPE html>
<html>

<!-- ACKNOWLEDGEMENT: Table styling based on https://github.com/QualityDU/QualityDU/blob/master/backend/templates/act/acts-table.html -->

<head>
  <title>LabMate Reagents</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>

  <style>

  </style>

  <div class="container my-4">
    <h2 class="text-center mb-4" id="reagentSummaryH2">BSTFA - reagent summary</h2>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-primary">
          <tr>
            <th>Param</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Reagent name</td>
            <td id="reagentNameTd">BSTFA</td>
          </tr>
          <tr>
            <td>Vendor</td>
            <td id="reagentVendorTd">Sigma Aldrich</td>
          </tr>
          <tr>
            <td>Reagent type</td>
            <td id="reagentTypeTd">organosilicon compounds</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Centered Icons -->
    <div class="row justify-content-center mt-4">
      <div class="col-auto">
        <i class="fas fa-skull-crossbones fa-3x text-danger" title="Danger"></i>
      </div>
      <div class="col-auto">
        <i class="fas fa-radiation fa-3x text-warning" title="Radioactive"></i>
      </div>
      <div class="col-auto">
        <i class="fas fa-fire fa-3x text-danger" title="Flammable"></i>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2" id="spinnerCaption">Loading stuff...</p>
    </div>

    <!-- Comments -->
    <div class="container mt-5">
      <h2 class="mb-4">Comments</h2>

      <!-- Comment List -->
      <ul class="list-group mb-4" id="commentList">
        <!-- Comment 1 -->
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-1">John Doe</h5>
            <small class="text-muted">2 hours ago</small>
          </div>
          <p class="mb-1">You'd better not touch it</p>
        </li>

        <!-- Comment 2 -->
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-1">Jane Smith</h5>
            <small class="text-muted">5 hours ago</small>
          </div>
          <p class="mb-1">Use only under fume hood!</p>
        </li>

        <!-- Comment 3 -->
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-1">John Doe</h5>
            <small class="text-muted">2 hours ago</small>
          </div>
          <p class="mb-1">Don't accidentally blow up our city. Please please please please please</p>
        </li>

        <!-- Comment 4 -->
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-1">Jane Smith</h5>
            <small class="text-muted">5 hours ago</small>
          </div>
          <p class="mb-1">@everyone Won't be reasonable to eat it</p>
        </li>
      </ul>

      <!-- Post Comment Form -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Post a Comment</h5>
          <form id="commentForm">
            <!-- Name Input -->
            <div class="mb-3">
              <label for="commentName" class="form-label">Name</label>
              <input id="commentBoxUsername" type="text" class="form-control" id="commentName" placeholder="Your name" value="user123" required
                disabled>
            </div>

            <!-- Comment Input -->
            <div class="mb-3">
              <label for="commentText" class="form-label">Comment</label>
              <textarea class="form-control" id="commentText" rows="3" placeholder="Your comment" required></textarea>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
        </div>
      </div>

      <!-- Instances in inventory -->
      <div class="container mt-5">
        <h2 class="mb-4">Instances in inventory</h2>

        <!-- Add New Reagent Button -->
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal"
          data-bs-target="#addInventoryItemModal">Register new instance</button>
        <div class="input-group mb-3">

          <!-- "Filter by" Text -->
          <span class="input-group-text" id="inventoryFilterSelectFromSpan">Select from</span>

          <!-- Select Dropdown -->
          <select id="inventoryFilterSelectFrom" class="form-select form-select-lg flex-grow-1" aria-label="Filter options">
            <option selected value="1">lab</option>
            <option value="2">faculty</option>
          </select>

          <!-- Input Field -->
          <!--<input type="text" class="form-control flex-grow-1" placeholder="Filter value" aria-label="Filter value">-->
          <select class="form-select select2" id="inventoryFilterSelectWhat" required>
            <!--<option value="1">Lab 1</option>
            <option value="2">Lab 2</option>
            <option value="3">Lab 3</option>-->
          </select>

          <!-- Filter Button -->
          <button class="btn btn-outline-secondary" type="button" id="button-apply-inventory-filter">APPLY</button>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-primary">
              <tr>
                <th>EPC</th>
                <th>Date added</th>
                <th>Expiration date</th>
                <th>Operations</th> <!-- New column for actions -->
              </tr>
            </thead>
            <tbody id="inventory-tbody">
              <!--<tr>
                <td>AAAAAAAAAAAAAAAAAAAAAAAA</td>
                <td>2025-01-03 11:15:28</td>
                <td>2025-01-03 11:15:28</td>
                <td>
                  <=== Write tag Button ==>
                  <button type="button" class="btn btn-sm btn-primary me-2">
                    write tag
                  </button>
                  <=== Print label Button ==>
                  <button type="button" class="btn btn-sm btn-secondary me-2">
                    print label
                  </button>
                  <=== Track Button ==>
                  <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal"
                    data-bs-target="#canvasModal">
                    Track
                  </button>
                </td>
              </tr>
              <tr>
                <td>BBBBBBBBBBBBBBBBBBBBBBBB</td>
                <td>2025-01-03 11:15:28</td>
                <td>2025-01-03 11:15:28</td>
                <td>
                  <=== Write tag Button ==>
                  <button type="button" class="btn btn-sm btn-primary me-2">
                    write tag
                  </button>
                  <=== Print label Button ==>
                  <button type="button" class="btn btn-sm btn-secondary me-2">
                    print label
                  </button>
                  <=== Track Button ==>
                  <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal"
                    data-bs-target="#canvasModal">
                    Track
                  </button>
                </td>
              </tr>-->
            </tbody>
          </table>
        </div>

      </div>

      <!-- Modal for Adding inventory item -->
      <div class="modal fade" id="addInventoryItemModal" tabindex="-1" aria-labelledby="addInventoryItemModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
              <h5 class="modal-title" id="addInventoryItemModalLabel">Add New Reagent</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
              <form id="modalInventoryItemForm">
                <!-- EPC Input -->
                <div class="mb-3">
                  <label for="modalInventoryItemEPC" class="form-label">EPC</label>
                  <input type="text" class="form-control" id="modalInventoryItemEPC" placeholder="Enter inventory item EPC"
                    required>
                </div>

                <!-- Lab Dropdown (Searchable) -->
                <div class="mb-3">
                  <label for="modalInventoryItemLabSelect" class="form-label">Lab</label>
                  <select class="form-select select2" id="modalInventoryItemLabSelect" required>
                    <option value="">Select a lab</option>
                    <!--<option value="1">Lab 1</option>
                    <option value="2">Lab 2</option>
                    <option value="3">Lab 3</option>-->
                  </select>
                </div>

                <div class="mb-3">
                  <label for="modalInventoryItemAddDate" class="form-label">Add date</label>
                  <input type="date" class="form-control" id="modalInventoryItemAddDate" required>
                </div>

                <div class="mb-3">
                  <label for="modalInventoryItemExpirationDate" class="form-label">Expiration date</label>
                  <input type="date" class="form-control" id="modalInventoryItemExpirationDate" required>
                </div>
              </form>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary" form="modalInventoryItemForm" id="modalSubmitButton">Save</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal for tracking inventory item (canvasModal) -->
      <div class="modal fade" id="canvasModal" tabindex="-1" aria-labelledby="canvasModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="canvasModalLabel">Item tracker</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <!-- Canvas Element -->
              <canvas id="myCanvas" width="600" height="400" style="border: 1px solid #000;"></canvas>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <nav aria-label="Paginacja">
      <ul class="pagination justify-content-center">

        <li class="page-item disabled"><span class="page-link">«</span></li>

        <li class="page-item active"><span class="page-link">1</span></li>

        <li class="page-item"><a class="page-link" href="/act/all?page=2">2</a></li>

        <li class="page-item"><a class="page-link" href="/act/all?page=3">3</a></li>

        <li class="page-item disabled"><span class="page-link">…</span></li>

        <li class="page-item"><a class="page-link" href="/act/all?page=4337">4337</a></li>

        <li class="page-item"><a class="page-link" href="/act/all?page=4338">4338</a></li>

        <li class="page-item">
          <a class="page-link" href="/act/all?page=2" aria-label="Następna">
            »
          </a>
        </li>

      </ul>
    </nav>

  </div>

  <script>
    const LABSERV_API_URL = "http://127.0.0.1:7890/api";

    let globals = {
      "elements": null,
    };

    function showUserAlertElement(message, type = "success") {
      let alertElement = document.createElement("div");
      alertElement.classList.add("alert");
      alertElement.classList.add(`alert-${type}`);
      alertElement.classList.add("alert-dismissible");
      alertElement.classList.add("fade");
      alertElement.classList.add("show");
      alertElement.setAttribute("role", "alert");
      alertElement.textContent = message;
      let button = document.createElement("button");
      button.type = "button";
      button.classList.add("btn-close");
      button.setAttribute("data-bs-dismiss", "alert");
      button.setAttribute("aria-label", "Close");
      alertElement.appendChild(button);
      globals.elements.reagentSummaryH2.before(alertElement);
    }

    function assert(condition, message, shouldAlert = true) {
      if (!condition) {
        if (shouldAlert) {
          //alert(message || "Assertion failed!"); // Show a message to the user  
          showUserAlertElement(message || "Assertion failed!", "danger");
        }
        const error = new Error(message || "Assertion failed!");
        error.isFromAssertion = true;
        console.log(error.stack); //print backtrace
        throw error; // Aim to stop execution
      }
    }

    function __parentCheck() {
      if (window.self == window.parent) {
        alert('You tinkered with the website, so now it won\'t work. Bye bye');
        window.location.href = 'logged-common.html?c=chat';
        return;
      }
    }
    
    function getElements() {
      return {
        modalInventoryItemForm: document.getElementById("modalInventoryItemForm"), //modal
        modalInventoryItemEPC: document.getElementById("modalInventoryItemEPC"), //modal
        modalInventoryItemLabSelect: document.getElementById("modalInventoryItemLabSelect"), //modal
        modalInventoryItemAddDate: document.getElementById("modalInventoryItemAddDate"), //modal
        modalInventoryItemExpirationDate: document.getElementById("modalInventoryItemExpirationDate"), //modal
        modalSubmitButton: document.getElementById("modalSubmitButton"), //modal
        inventoryTbody: document.getElementById("inventory-tbody"),
        inventoryFilterSelectFromSpan: document.getElementById("inventoryFilterSelectFromSpan"),
        inventoryFilterSelectFrom: document.getElementById("inventoryFilterSelectFrom"),
        inventoryFilterSelectWhat: document.getElementById("inventoryFilterSelectWhat"),
        applyInventoryFilterButton: document.getElementById("button-apply-inventory-filter"),
        addInventoryItemModal: document.getElementById("addInventoryItemModal"),
        reagentSummaryH2: document.getElementById("reagentSummaryH2"),
        reagentNameTd: document.getElementById("reagentNameTd"),
        reagentVendorTd: document.getElementById("reagentVendorTd"),
        reagentTypeTd: document.getElementById("reagentTypeTd"),
        loadingSpinner: document.getElementById("loadingSpinner"),
        spinnerCaption: document.getElementById("spinnerCaption"),
        commentBoxUsername: document.getElementById("commentBoxUsername"),
      }
    }

    function showSpinner(elements) {
      elements.loadingSpinner.style.display = "block";
    }

    function hideSpinner(elements) {
      elements.loadingSpinner.style.display = "none";
    }

    function setSpinnerCaption(elements, caption) {
      elements.spinnerCaption.textContent = caption;
    }

    function spinnerCaptionRestoreDefault() {
      setSpinnerCaption(globals.elements, "Loading stuff...");
    }

    async function fetchXsCount(xsName) {
      assert(typeof xsName === "string", "xsName is not a string");
      showSpinner(globals.elements);
      try {
        const response = await fetch(`${LABSERV_API_URL}/${xsName}`);
        assert(response.ok, `Failed to fetch ${xsName} count! Falsy response.ok, response.status=${response.status}`);
        const data = await response.json();
        
        assert(data, `data is falsy`);
        console.log(`GET ${LABSERV_API_URL}/${xsName}`, data);
        assert(data.status, `status is falsy`);
        if (data.status !== "success") {
          assert(false, `Failed to fetch ${xsName} count! Message from LABSERV: ${data.message}`);
          return -1;
        } else {
          assert(data[`${xsName}_count`] || data[`${xsName}_count`] === 0, `${xsName}_count is falsy and not 0`);
          assert(data[`${xsName}_count`] >= 0, `${xsName}_count is negative`);
          if (data[`${xsName}_count`] === 0) {
            console.log(`No ${xsName} found`);
            alert(`No ${xsName} found yet... Add some?`);
          }
          return data[`${xsName}_count`];
        }
      } catch (error) {
        assert(false, `Failed to fetch ${xsName} count! Error: ${error}`, error.isFromAssertion !== true);
        return -1;
      } finally {
        hideSpinner(globals.elements);
      }
    }

    function __fetchXs_ParametrizationObject_SanCheck(xParametrizationObject) {
      assert(typeof xParametrizationObject === "object", "xParametrizationObject is not an object");
      assert(typeof xParametrizationObject.xsName === "string", "xParametrizationObject.xsName is not a string");
      assert(Array.isArray(xParametrizationObject.xFilterOptions), "xParametrizationObject.xFilterOptions is not an array");
      for (let i = 0; i < xParametrizationObject.xFilterOptions.length; i++) {
        assert(typeof xParametrizationObject.xFilterOptions[i] === "string", "xParametrizationObject.xFilterOptions[i] is not a string");
      }
    }

    function __fetchXs_ParametrizationObject(xsName, xFilterOptions) {
      assert(typeof xsName === "string", "xsName is not a string");
      assert(Array.isArray(xFilterOptions), "xFilterOptions is not an array");
      for (let i = 0; i < xFilterOptions.length; i++) {
        assert(typeof xFilterOptions[i] === "string", "xFilterOptions[i] is not a string");
      }
      return {
        "xsName": xsName,
        "xFilterOptions": xFilterOptions
      };
    }

    async function fetchXs(xParametrizationObject, filterParam, filterValue, p_offset, p_size) {
      __fetchXs_ParametrizationObject_SanCheck(xParametrizationObject);
      assert(xParametrizationObject.xFilterOptions.includes(filterParam), "Invalid filterParam");
      assert(typeof filterValue === "string", "filterValue is not a string");
      assert(typeof p_offset === "number", "p_offset is not a number");
      assert(typeof p_size === "number", "p_size is not a number");
      assert(p_offset >= 0, "p_offset is negative");
      assert(p_size > 0, "p_size is not positive");
      assert(Number.isInteger(p_offset), "p_offset is not an integer");
      assert(Number.isInteger(p_size), "p_size is not an integer");

      showSpinner(globals.elements);
      try {
        const response = await fetch(`${LABSERV_API_URL}/${xParametrizationObject.xsName}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            filter: `${filterParam}`,
            value: `${filterValue}`,
            p_offset: p_offset,
            p_size: p_size
          })
        });
        assert(response.ok, `Failed to fetch ${xParametrizationObject.xsName}! Falsy response.ok, response.status=${response.status}`);
        const data = await response.json();
        
        assert(data, `data is falsy`);
        console.log(`POST ${LABSERV_API_URL}/${xParametrizationObject.xsName}`, data);
        assert(data.status, `status is falsy`);
        if (data.status !== "success") {
          assert(false, `Failed to fetch ${xParametrizationObject.xsName}! Message from LABSERV: ${data.message}`);
          return [];
        } else {
          assert(data[xParametrizationObject.xsName], `${xParametrizationObject.xsName} is falsy`);
          assert(Array.isArray(data[xParametrizationObject.xsName]), `${xParametrizationObject.xsName} is not an array`);
          if (!(data[xParametrizationObject.xsName].length > 0)) {
            alert(`Empty ${xParametrizationObject.xsName} list obtained!`);
          }
          return data[xParametrizationObject.xsName];
        }
      } catch (error) {
        assert(false, `Failed to fetch ${xParametrizationObject.xsName}! Error: ${error}`, error.isFromAssertion !== true);
        return [];
      } finally {
        hideSpinner(globals.elements);
      }
    }

    async function fetchReagent(reagentId) {
      assert(typeof reagentId === "number", "Reagent ID must be a number");
      assert(Number.isInteger(reagentId), "Reagent ID must be an integer");
      
      showSpinner(globals.elements);
      try {
        const response = await fetch(`${LABSERV_API_URL}/reagent?reagent_id=${reagentId}`);
        assert(response.ok, "Failed to fetch reagent data");
        const data = await response.json();

        assert(data, "data is falsy");
        console.log(`GET ${LABSERV_API_URL}/reagent?reagent_id=${reagentId}`, data);
        assert(data.status, "status is falsy");
        if (data.status !== "success") {
          assert(false, `Failed to fetch reagent data! Message from LABSERV: ${data.message}`);
          return null;
        } else {
          assert(data.reagent, "reagent is falsy");
          assert(data.reagent.reagent_id, "reagent.reagent_id is falsy");
          assert(data.reagent.reagent_id === reagentId, "reagent.reagent_id does not match the requested reagent ID");
          assert(data.reagent.name, "reagent.name is falsy");
          assert(data.reagent.vendor, "reagent.vendor is falsy");
          assert(data.reagent.reagtype_id, "reagent.reagtype_id is falsy");
          return data.reagent;
        }
      } catch (error) {
        console.error("Error:", error);
        alert("Failed to fetch reagent data for unexpected reason");
        return null;
      } finally {
        hideSpinner(globals.elements);
        spinnerCaptionRestoreDefault();
      }
    }

    async function fetchReagtype(reagtypeId) {
      assert(typeof reagtypeId === "number", "Reagtype ID must be a number");
      assert(Number.isInteger(reagtypeId), "Reagtype ID must be an integer");
      
      showSpinner(globals.elements);
      try {
        const response = await fetch(`${LABSERV_API_URL}/reagtype?reagtype_id=${reagtypeId}`);
        assert(response.ok, "Failed to fetch reagtype data");
        const data = await response.json();

        assert(data, "data is falsy");
        console.log(`GET ${LABSERV_API_URL}/reagtype?reagtype_id=${reagtypeId}`, data);
        assert(data.status, "status is falsy");
        if (data.status !== "success") {
          assert(false, `Failed to fetch reagtype data! Message from LABSERV: ${data.message}`);
          return null;
        } else {
          assert(data.reagtype, "reagtype is falsy");
          assert(data.reagtype.reagtype_id, "reagtype.reagtype_id is falsy");
          assert(data.reagtype.reagtype_id === reagtypeId, "reagtype.reagtype_id does not match the requested reagtype ID");
          assert(data.reagtype.name, "reagtype.name is falsy");
          return data.reagtype;
        }
      } catch (error) {
        console.error("Error:", error);
        alert("Failed to fetch reagtype data for unexpected reason");
        return null;
      } finally {
        hideSpinner(globals.elements);
        spinnerCaptionRestoreDefault();
      }
    }

    async function fetchLabs(filterParam, filterValue, p_offset, p_size) {
      const xParametrizationObject = __fetchXs_ParametrizationObject("labs", ["none", "name", "fid", "uid"]);
      return fetchXs(xParametrizationObject, filterParam, filterValue, p_offset, p_size);
    }

    async function fetchLabsByUserId(userId, p_offset, p_size) {
      console.log("userId", userId);
      assert(typeof userId === "number", "User ID must be a number");
      assert(Number.isInteger(userId), "User ID must be an integer");
      return fetchLabs("uid", `${userId}`, p_offset, p_size);
    }

    async function fetchFaculties(filterParam, filterValue, p_offset, p_size) {
      const xParametrizationObject = __fetchXs_ParametrizationObject("faculties", ["none", "name", "uid", "email_domain"]);
      return fetchXs(xParametrizationObject, filterParam, filterValue, p_offset, p_size);
    }

    async function fetchFacultiesAll(p_offset, p_size) {
      return fetchFaculties("none", "", p_offset, p_size);
    }

    async function fetchFacultiesByUserId(userId, p_offset, p_size) {
      assert(typeof userId === "number", "User ID must be a number");
      assert(Number.isInteger(userId), "User ID must be an integer");
      return fetchFaculties("uid", `${userId}`, p_offset, p_size);
    }

    async function fetchInventoryItems(filterParam, filterValue, p_offset, p_size) {
      const xParametrizationObject = __fetchXs_ParametrizationObject("inventory-items", ["none", "lid", "fid", "epc", "rid", "rid_lid", "rid_fid", "emb"]);
      return fetchXs(xParametrizationObject, filterParam, filterValue, p_offset, p_size);
    }

    async function fetchInventoryItemsByLabId(labId, p_offset, p_size) {
      assert(typeof labId === "number", "Lab ID must be a number");
      assert(Number.isInteger(labId), "Lab ID must be an integer");
      return fetchInventoryItems("lid", `${labId}`, p_offset, p_size);
    }

    async function fetchInventoryItemsByFacultyId(facultyId, p_offset, p_size) {
      assert(typeof facultyId === "number", "Faculty ID must be a number");
      assert(Number.isInteger(facultyId), "Faculty ID must be an integer");
      return fetchInventoryItems("fid", `${facultyId}`, p_offset, p_size);
    }

    async function fetchInventoryItemsByRidLid(reagentId, labId, p_offset, p_size) {
      assert(typeof reagentId === "number", "Reagent ID must be a number");
      assert(Number.isInteger(reagentId), "Reagent ID must be an integer");
      assert(typeof labId === "number", "Lab ID must be a number");
      assert(Number.isInteger(labId), "Lab ID must be an integer");
      return fetchInventoryItems("rid_lid", `${reagentId}&${labId}`, p_offset, p_size);
    }

    async function fetchInventoryItemsByRidFid(reagentId, facultyId, p_offset, p_size) {
      assert(typeof reagentId === "number", "Reagent ID must be a number");
      assert(Number.isInteger(reagentId), "Reagent ID must be an integer");
      assert(typeof facultyId === "number", "Faculty ID must be a number");
      assert(Number.isInteger(facultyId), "Faculty ID must be an integer");
      return fetchInventoryItems("rid_fid", `${reagentId}&${facultyId}`, p_offset, p_size);
    }

    async function uploadInventoryItem(reagentId, dateAdded, dateExpire, labId, epc, apwd, kpwd, username, sesskey) {
      //PUT -d '{"rgid":<reagent id>, "dadd":"<date added>", "dexp": "<date expire>", "lid":<lab id>, "epc": "<epc>", "apwd": "<apwd>", "kpwd":"<kpwd>", "username":"<username>", "session_key":"<sesskey>"}' `${LABSERV_API_URL}/inventory` -> { status: "success|error", message: "...", inventory_item: { inventory_item_id: <inventory item id>, reagent_id: <reagent id>, date_added: "<date added>", date_expire: "<date expire>", lab_id: <lab id>, epc: "<epc>" }}
      assert(typeof reagentId === "number", "Reagent ID must be a number");
      assert(Number.isInteger(reagentId), "Reagent ID must be an integer");
      assert(typeof dateAdded === "string", "Date added must be a string");
      assert(typeof dateExpire === "string", "Date expire must be a string");
      assert(typeof labId === "number", "Lab ID must be a number");
      assert(Number.isInteger(labId), "Lab ID must be an integer");
      assert(typeof epc === "string", "EPC must be a string");
      assert(typeof apwd === "string", "APWD must be a string");
      assert(typeof kpwd === "string", "KPWD must be a string");
      assert(typeof username === "string", "Username must be a string");
      assert(typeof sesskey === "string", "Session key must be a string");

      showSpinner(globals.elements);
      try {
        const response = await fetch(`${LABSERV_API_URL}/inventory`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            rgid: reagentId,
            dadd: dateAdded,
            dexp: dateExpire,
            lid: labId,
            epc: epc,
            apwd: apwd,
            kpwd: kpwd,
            username: username,
            session_key: sesskey
          })
        });
        assert(response.ok, "Failed to upload inventory item");
        const data = await response.json();

        assert(data, "data is falsy");
        console.log(`PUT ${LABSERV_API_URL}/inventory`, data);
        assert(data.status, "status is falsy");
        if (data.status !== "success") {
          assert(false, `Failed to upload inventory item! Message from LABSERV: ${data.message}`);
          return null;
        } else {
          assert(data.inventory_item, "inventory_item is falsy");
          assert(data.inventory_item.inventory_item_id, "inventory_item.inventory_item_id is falsy");
          assert(data.inventory_item.reagent_id, "inventory_item.reagent_id is falsy");
          assert(data.inventory_item.reagent_id === reagentId, "inventory_item.reagent_id does not match the requested reagent ID");
          assert(data.inventory_item.date_added, "inventory_item.date_added is falsy");
          assert(data.inventory_item.date_expire, "inventory_item.date_expire is falsy");
          assert(data.inventory_item.lab_id, "inventory_item.lab_id is falsy");
          assert(data.inventory_item.lab_id === labId, "inventory_item.lab_id does not match the requested lab ID");
          assert(data.inventory_item.epc, "inventory_item.epc is falsy");
          return data.inventory_item;
        }
      } catch (error) {
        console.error("Error:", error);
        assert(false, `Failed to upload inventory item: ${error}`);
        return null;
      } finally {
        hideSpinner(globals.elements);
        spinnerCaptionRestoreDefault();
      }
    }

    function __removeFilterValueElementIfExists() {
      let filterSelectWhat = globals.elements.inventoryFilterSelectWhat;
      if (filterSelectWhat) {
        filterSelectWhat.remove();
      }
    }

    async function __loadInventoryFilterValues(elements) {
      let filterSelectFromOpt = elements.inventoryFilterSelectFrom.value;
      let filterSelectWhatOpts = [];
      switch (filterSelectFromOpt) {
        case "1": //lab
          console.log("LOADING INVENTORY FILTER VALUES (LABS)");
          assert(localStorage.getItem("user_id"), "User ID is falsy");
          let user_labs = await fetchLabsByUserId(Number(localStorage.getItem("user_id")), 0, 10);
          for (let i = 0; i < user_labs.length; i++) {
            assert(user_labs[i].lab_id, "lab_id is falsy");
            assert(user_labs[i].name, "name is falsy");
            filterSelectWhatOpts.push({
              "name": user_labs[i].name,
              "id": user_labs[i].lab_id
            });
          }
          break;
        case "2": //faculty
          console.log("LOADING INVENTORY FILTER VALUES (FACULTIES)");
          assert(localStorage.getItem("user_id"), "User ID is falsy");
          let user_faculties = await fetchFacultiesByUserId(Number(localStorage.getItem("user_id")), 0, 10);
          for (let i = 0; i < user_faculties.length; i++) {
            assert(user_faculties[i].faculty_id, "faculty_id is falsy");
            assert(user_faculties[i].name, "name is falsy");
            filterSelectWhatOpts.push({
              "name": user_faculties[i].name,
              "id": user_faculties[i].faculty_id
            });
          }
          break;
        default:
          assert(false, `Invalid filterSelectFromOpt "${filterSelectFromOpt}"`);
          break;
      }

      console.log("filterSelectWhatOpts:", filterSelectWhatOpts);

      __removeFilterValueElementIfExists();
      elements.inventoryFilterSelectWhat = document.createElement("select");
      elements.inventoryFilterSelectWhat.classList.add("form-select");
      elements.inventoryFilterSelectWhat.classList.add("select2");
      elements.inventoryFilterSelectWhat.setAttribute("aria-label", "Filter type");
      elements.inventoryFilterSelectWhat.id = "inventoryFilterSelectWhat";
      elements.inventoryFilterSelectWhat.required = true;
      for (let i = 0; i < filterSelectWhatOpts.length; i++) {
        let option = document.createElement("option");
        option.value = filterSelectWhatOpts[i].id;
        option.textContent = filterSelectWhatOpts[i].name;
        elements.inventoryFilterSelectWhat.appendChild(option);
      }
      elements.inventoryFilterSelectFrom.after(elements.inventoryFilterSelectWhat);
    }

    async function __reloadInventoryList(elements, reagentId) {
      let filterSelectFromOpt = elements.inventoryFilterSelectFrom.value;
      let filterSelectWhatOpt = elements.inventoryFilterSelectWhat.value;
      let filterParam = "";
      let filterValue = "";
      let inventoryItems = [];
      switch (filterSelectFromOpt) {
        case "1": //lab
          filterParam = "lid";
          filterValue = Number(filterSelectWhatOpt);
          assert(Number.isInteger(filterValue), "filterValue is not an integer");
          //inventoryItems = await fetchInventoryItemsByLabId(filterValue, 0, 10);
          inventoryItems = await fetchInventoryItemsByRidLid(reagentId, filterValue, 0, 10);
          break;
        case "2": //faculty
          filterParam = "fid";
          filterValue = Number(filterSelectWhatOpt);
          assert(Number.isInteger(filterValue), "filterValue is not an integer");
          //inventoryItems = await fetchInventoryItemsByFacultyId(filterValue, 0, 10);
          inventoryItems = await fetchInventoryItemsByRidFid(reagentId, filterValue, 0, 10);
          break;
        default:
          assert(false, `Invalid filterSelectFromOpt "${filterSelectFromOpt}"`);
          break;
      }
      
      console.log("Inventory items:", inventoryItems);
      //clear the table
      elements.inventoryTbody.innerHTML = "";
      //refill the table
      for (let i = 0; i < inventoryItems.length; i++) {
        let tr = document.createElement("tr");
        let tdEpc = document.createElement("td");
        let ttEpc = document.createElement("tt");
        let tdDateAdded = document.createElement("td");
        let tdDateExpire = document.createElement("td");
        let tdOperations = document.createElement("td");
        let writeTagButton = document.createElement("button");
        let printLabelButton = document.createElement("button");
        let trackButton = document.createElement("button");

        ttEpc.textContent = inventoryItems[i].epc;
        tdDateAdded.textContent = inventoryItems[i].date_added;
        tdDateExpire.textContent = inventoryItems[i].date_expire;
        writeTagButton.type = "button";
        writeTagButton.classList.add("btn");
        writeTagButton.classList.add("btn-sm");
        writeTagButton.classList.add("btn-primary");
        writeTagButton.classList.add("me-2");
        writeTagButton.textContent = "write tag";
        printLabelButton.type = "button";
        printLabelButton.classList.add("btn");
        printLabelButton.classList.add("btn-sm");
        printLabelButton.classList.add("btn-secondary");
        printLabelButton.classList.add("me-2");
        printLabelButton.textContent = "print label";
        trackButton.type = "button";
        trackButton.classList.add("btn");
        trackButton.classList.add("btn-sm");
        trackButton.classList.add("btn-info");
        trackButton.setAttribute("data-bs-toggle", "modal");
        trackButton.setAttribute("data-bs-target", "#canvasModal");
        trackButton.textContent = "Track";

        tdEpc.appendChild(ttEpc);

        tdOperations.appendChild(writeTagButton);
        tdOperations.appendChild(printLabelButton);
        tdOperations.appendChild(trackButton);

        tr.appendChild(tdEpc);
        tr.appendChild(tdDateAdded);
        tr.appendChild(tdDateExpire);
        tr.appendChild(tdOperations);

        elements.inventoryTbody.appendChild(tr);
        //TODO Set actions for buttons
      }
    }

    async function preloadContent(elements, reagentId) {
      let reagent = await fetchReagent(reagentId);
      assert(reagent, "reagent is falsy");  
      let reagtype = await fetchReagtype(reagent.reagtype_id);
      assert(reagtype, "reagtype is falsy");
      elements.reagentSummaryH2.textContent = `${reagent.name} - reagent summary`;
      elements.reagentNameTd.textContent = reagent.name;
      elements.reagentVendorTd.textContent = reagent.vendor;
      elements.reagentTypeTd.textContent = reagtype.name;
      let username = localStorage.getItem("username");
      assert(username, "Username is falsy");
      elements.commentBoxUsername.value = username;

      assert(localStorage.getItem("user_id"), "User ID is falsy");
      let user_labs = await fetchLabsByUserId(Number(localStorage.getItem("user_id")), 0, 10);
      console.log("User labs:", user_labs);
      //add labs to select
      for (let i = 0; i < user_labs.length; i++) {
        let option = document.createElement("option");
        assert(user_labs[i].lab_id, "lab_id is falsy");
        assert(user_labs[i].name, "name is falsy");
        option.value = user_labs[i].lab_id;
        option.textContent = user_labs[i].name;
        elements.modalInventoryItemLabSelect.appendChild(option);
      }

      await __loadInventoryFilterValues(elements);
      await __reloadInventoryList(elements, reagentId);
    }

    function __setActions_inventoryFormSubmission(elements, reagentId) {
      elements.modalInventoryItemForm
      .addEventListener("submit", async function (event) {
        event.preventDefault();
        let epc = elements.modalInventoryItemEPC.value;
        let labId = Number(elements.modalInventoryItemLabSelect.value);
        let dateAdded = elements.modalInventoryItemAddDate.value;
        let dateExpire = elements.modalInventoryItemExpirationDate.value;
        let username = localStorage.getItem("username");
        let sesskey = localStorage.getItem("session_key");
        
        assert(epc, "EPC is falsy");
        assert(labId, "Lab ID is falsy");
        assert(dateAdded, "Date added is falsy");
        assert(dateExpire, "Expiration date is falsy");
        assert(username, "Username is falsy");
        assert(sesskey, "Session key is falsy");

        //Generate random APWD and KPWD (4 bytes written as hex)
        let apwd = Math.floor(Math.random() * 0x100000000).toString(16).padStart(8, '0');
        let kpwd = Math.floor(Math.random() * 0x100000000).toString(16).padStart(8, '0');
        console.log(`APWD: ${apwd}, KPWD: ${kpwd}`);
        
        //Close the modal and clear form
        const modal = bootstrap.Modal.getInstance(
          elements.addInventoryItemModal
        );
        modal.hide();
        elements.modalInventoryItemForm.reset();

        //Upload the inventory item
        await uploadInventoryItem(reagentId, dateAdded, dateExpire, labId, epc, apwd, kpwd, username, sesskey);

        //Reload the inventory list
        await __reloadInventoryList(elements, reagentId);
      });
    }

    function __setActions_inventoryFilterOptionsChange(elements) {
      elements.inventoryFilterSelectFrom
      .addEventListener("change", async function (event) {
        await __loadInventoryFilterValues(elements);
      });
    }

    function __setActions_inventoryFilterApply(elements, reagentId) {
      elements.applyInventoryFilterButton
      .addEventListener("click", async function (event) {
        await __reloadInventoryList(elements, reagentId);
      });
    }

    function setActions(elements, reagentId) {
      __setActions_inventoryFormSubmission(elements, reagentId);
      __setActions_inventoryFilterOptionsChange(elements);
      __setActions_inventoryFilterApply(elements, reagentId);
    }

    window.onload = async function() {
      __parentCheck();
      let urlParams = new URLSearchParams(window.location.search);
      let reagentId = urlParams.get('id');
      if (!reagentId) {
        alert('No reagent ID provided. Bye bye');
        console.log(window.location.search);
        window.location.href = '/reagents.html';
        return;
      }
      reagentId = Number(reagentId);
      assert(reagentId, "Reagent ID conversion to number failure");
      console.log(`Reagent ID: ${reagentId}`);
      globals.window = window;
      globals.elements = getElements();
      await preloadContent(globals.elements, reagentId);
      setActions(globals.elements, reagentId);
      console.log(globals);
    }
  </script>
</body>

</html>